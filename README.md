# ESP32-C3 CANBus Library

![–õ–∏—Ü–µ–Ω–∑–∏—è](https://img.shields.io/badge/license-Unlicense-blue.svg)
![PlatformIO](https://img.shields.io/badge/platform-ESP32--C3-green.svg)
![Version](https://img.shields.io/badge/version-1.1.0-orange)

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CAN-—à–∏–Ω–æ–π —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä TWAI –Ω–∞ ESP32-C3.

## üî• –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö (11-bit) –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö (29-bit) –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤
- –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–æ 32 —Ñ–∏–ª—å—Ç—Ä–æ–≤)
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ callback-—Ñ—É–Ω–∫—Ü–∏–∏
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ—Ä–µ–π–º–æ–≤
- –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏
- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π watchdog –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–µ–π –æ—Ç 25 kbit/s –¥–æ 1 Mbit/s

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ß–µ—Ä–µ–∑ PlatformIO

–î–æ–±–∞–≤—å—Ç–µ –≤ –≤–∞—à `platformio.ini`:
```ini
lib_deps =
    PJ82RU/esp32-c3-canbus
```

### –ß–µ—Ä–µ–∑ Arduino IDE

1. –°–∫–∞—á–∞–π—Ç–µ [–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑](https://github.com/PJ82RU/esp32-c3-canbus/releases)
2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –≤ –ø–∞–ø–∫—É `~/Arduino/libraries/`

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```cpp
#include "canbus/can.h"

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CAN (TX: GPIO5, RX: GPIO6)
canbus::Can can(GPIO_NUM_5, GPIO_NUM_6);

void app_main() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ callback –¥–ª—è –ø—Ä–∏–µ–º–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    can.bind(std::make_unique<esp32_c3::objects::Callback<canbus::CanFrame>>(
        "CAN_Callback", 5, 10, 3072, 18));
    
    // –ó–∞–ø—É—Å–∫ CAN –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ 500 kbit/s
    can.start(canbus::CanSpeed::SPEED_500KBIT);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ—Ä–µ–π–º–∞
    canbus::CanFrame frame;
    frame.id = 0x123;
    frame.data.bytes[0] = 0xAA;
    frame.length = 1;
    can.send(frame);
}
```

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏:

```cpp
enum class CanSpeed {
    SPEED_25KBIT,   // 25 kbit/s
    SPEED_50KBIT,   // 50 kbit/s
    SPEED_100KBIT,  // 100 kbit/s
    SPEED_125KBIT,  // 125 kbit/s
    SPEED_250KBIT,  // 250 kbit/s
    SPEED_500KBIT,  // 500 kbit/s
    SPEED_800KBIT,  // 800 kbit/s
    SPEED_1MBIT     // 1 Mbit/s
};
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤:

```cpp
// –§–∏–ª—å—Ç—Ä –¥–ª—è ID 0x100-0x1FF (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)
can.setFilter(0x100, 0x700, false);

// –§–∏–ª—å—Ç—Ä –¥–ª—è ID 0x18000000-0x180000FF (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π)
can.setFilter(0x18000000, 0x180000FF, true);
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã:

| –ú–µ—Ç–æ–¥                           | –û–ø–∏—Å–∞–Ω–∏–µ                          |
|---------------------------------|-----------------------------------|
| `start(speed)`                  | –ó–∞–ø—É—Å–∫ CAN-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞            |
| `stop()`                        | –û—Å—Ç–∞–Ω–æ–≤–∫–∞ CAN-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞         |
| `send(frame)`                   | –û—Ç–ø—Ä–∞–≤–∫–∞ CAN-—Ñ—Ä–µ–π–º–∞               |
| `bind(callback)`                | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π |
| `setFilter(id, mask, extended)` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞                 |

## üîß –ü—Ä–∏–º–µ—Ä—ã

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞:

```cpp
can.bindFrameEntry(
    []() { // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ—Ä–µ–π–º–∞
        static uint8_t counter = 0;
        canbus::CanFrame frame;
        frame.id = 0x200;
        frame.data.bytes[0] = counter++;
        frame.length = 1;
        return frame;
    },
    100, // –ò–Ω—Ç–µ—Ä–≤–∞–ª (–º—Å)
    10   // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–æ–∫ (0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ)
);
```

## ü§ù –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —á–∏–ø—ã: **ESP32-C3**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏:
    - ESP-IDF
    - Arduino (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏)

## üìú –õ–∏—Ü–µ–Ω–∑–∏—è

–ü—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π [Unlicense](https://unlicense.org/).

---
–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ [PJ82](mailto:project82@mail.ru) | [GitHub](https://github.com/PJ82RU/esp32-c3-canbus)

```
